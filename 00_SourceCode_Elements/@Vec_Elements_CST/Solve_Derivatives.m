function [dedx,d2edx2] = Solve_Derivatives(obj,...
    x_reshape,l_mat)

    % Here this function will compute the Jacobian and 
    % the Hessian of the epsilon matrix. 
    % dedx is of size {Ncst,3,9}. 
    % d2edx2 is of size {Ncst,3,9,9}. 
    
    ijk_mat=obj.node_ijk_mat; 
    Ncst=size(ijk_mat);
    Ncst=Ncst(1);

    L1_Vec=obj.L_mat(:,1);
    L2_Vec=obj.L_mat(:,2);
    L3_Vec=obj.L_mat(:,3);

    L_mat=obj.L_mat;

    l1_Vec=l_mat(:,1);
    l2_Vec=l_mat(:,2);
    l3_Vec=l_mat(:,3);

    x1_mat=x_reshape(:,1:3);
    x2_mat=x_reshape(:,4:6);
    x3_mat=x_reshape(:,7:9);

    % Solve for the derivatives for epsilon 1
    direction1=[zeros(Ncst,3),x2_mat-x3_mat,x3_mat-x2_mat];
    deps1dx=direction1./(l1_Vec*ones(1,9))./(L1_Vec*ones(1,9));

    % Solve for the derivatives for epsilon 2
    direction2=[x1_mat-x3_mat,zeros(Ncst,3),x3_mat-x1_mat];
    deps2dx=direction2./(l2_Vec*ones(1,9))./(L2_Vec*ones(1,9));

    % Solve for the derivatives for epsilon 3
    direction3=[x1_mat-x2_mat,x2_mat-x1_mat,zeros(Ncst,3)];
    deps3dx=direction3./(l3_Vec*ones(1,9))./(L3_Vec*ones(1,9));

    % Organize the Jacobian
    dedx=zeros(Ncst,3,9);
    dedx(:,1,:)=deps1dx;
    dedx(:,2,:)=deps2dx;
    dedx(:,3,:)=deps3dx;

    % Next is to solve for the Hessian matrix
    d2edx2=zeros(Ncst,3,9,9);

    % Construct the first part of Hessian for strain 1
    K1e1=zeros(Ncst,9,9);
    K1e1(:,4:6,4:6)=squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e1(:,7:9,7:9)=squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e1(:,4:6,7:9)=-squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e1(:,7:9,4:6)=-squeeze(tensorprod(ones(1,Ncst),eye(3)));

    % The vectorization is a little tricky
    K1e1(:,4,4:9)=squeeze(K1e1(:,4,4:9))./(L_mat(:,1)*ones(1,6))...
        ./(l_mat(:,1)*ones(1,6));
    K1e1(:,5,4:9)=squeeze(K1e1(:,5,4:9))./(L_mat(:,1)*ones(1,6))...
        ./(l_mat(:,1)*ones(1,6));
    K1e1(:,6,4:9)=squeeze(K1e1(:,6,4:9))./(L_mat(:,1)*ones(1,6))...
        ./(l_mat(:,1)*ones(1,6));
    K1e1(:,7,4:9)=squeeze(K1e1(:,7,4:9))./(L_mat(:,1)*ones(1,6))...
        ./(l_mat(:,1)*ones(1,6));
    K1e1(:,8,4:9)=squeeze(K1e1(:,8,4:9))./(L_mat(:,1)*ones(1,6))...
        ./(l_mat(:,1)*ones(1,6));
    K1e1(:,9,4:9)=squeeze(K1e1(:,9,4:9))./(L_mat(:,1)*ones(1,6))...
        ./(l_mat(:,1)*ones(1,6));

    % Construct the first part of Hessian for strain 2
    K1e2=zeros(Ncst,9,9);
    K1e2(:,1:3,1:3)=squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e2(:,7:9,7:9)=squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e2(:,1:3,7:9)=-squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e2(:,7:9,1:3)=-squeeze(tensorprod(ones(1,Ncst),eye(3)));

    K1e2(:,1,[1 2 3 7 8 9])=squeeze(K1e2(:,1,[1 2 3 7 8 9]))...
        ./(L_mat(:,2)*ones(1,6))./(l_mat(:,2)*ones(1,6));
    K1e2(:,2,[1 2 3 7 8 9])=squeeze(K1e2(:,2,[1 2 3 7 8 9]))...
        ./(L_mat(:,2)*ones(1,6))./(l_mat(:,2)*ones(1,6));
    K1e2(:,3,[1 2 3 7 8 9])=squeeze(K1e2(:,3,[1 2 3 7 8 9]))...
        ./(L_mat(:,2)*ones(1,6))./(l_mat(:,2)*ones(1,6));
    K1e2(:,7,[1 2 3 7 8 9])=squeeze(K1e2(:,7,[1 2 3 7 8 9]))...
        ./(L_mat(:,2)*ones(1,6))./(l_mat(:,2)*ones(1,6));
    K1e2(:,8,[1 2 3 7 8 9])=squeeze(K1e2(:,8,[1 2 3 7 8 9]))...
        ./(L_mat(:,2)*ones(1,6))./(l_mat(:,2)*ones(1,6));
    K1e2(:,9,[1 2 3 7 8 9])=squeeze(K1e2(:,9,[1 2 3 7 8 9]))...
        ./(L_mat(:,2)*ones(1,6))./(l_mat(:,2)*ones(1,6));    
    
    % Construct the first part of Hessian for strain 3
    K1e3=zeros(Ncst,9,9);
    K1e3(:,4:6,4:6)=squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e3(:,1:3,1:3)=squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e3(:,4:6,1:3)=-squeeze(tensorprod(ones(1,Ncst),eye(3)));
    K1e3(:,1:3,4:6)=-squeeze(tensorprod(ones(1,Ncst),eye(3)));

    K1e3(:,1,1:6)=squeeze(K1e3(:,1,1:6))...
        ./(L_mat(:,3)*ones(1,6))./(l_mat(:,3)*ones(1,6));
    K1e3(:,2,1:6)=squeeze(K1e3(:,2,1:6))...
        ./(L_mat(:,3)*ones(1,6))./(l_mat(:,3)*ones(1,6));
    K1e3(:,3,1:6)=squeeze(K1e3(:,3,1:6))...
        ./(L_mat(:,3)*ones(1,6))./(l_mat(:,3)*ones(1,6));
    K1e3(:,4,1:6)=squeeze(K1e3(:,4,1:6))...
        ./(L_mat(:,3)*ones(1,6))./(l_mat(:,3)*ones(1,6));
    K1e3(:,5,1:6)=squeeze(K1e3(:,5,1:6))...
        ./(L_mat(:,3)*ones(1,6))./(l_mat(:,3)*ones(1,6));
    K1e3(:,6,1:6)=squeeze(K1e3(:,6,1:6))...
        ./(L_mat(:,3)*ones(1,6))./(l_mat(:,3)*ones(1,6));

    % Assemble the first part of the matrix
    d2edx2(:,1,:,:)=K1e1;
    d2edx2(:,2,:,:)=K1e2;
    d2edx2(:,3,:,:)=K1e3;

    % Next we focus on the second part of the Hessian matrix
    % For the strain of bar 1
    K2e1=zeros(Ncst,9,9);

    % This code really looks ugly when vectorized
    K2e1(:,4,4)=direction1(:,4).*direction1(:,4)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,4,5)=direction1(:,4).*direction1(:,5)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,4,6)=direction1(:,4).*direction1(:,6)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,4,7)=direction1(:,4).*direction1(:,7)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,4,8)=direction1(:,4).*direction1(:,8)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,4,9)=direction1(:,4).*direction1(:,9)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);

    K2e1(:,5,4)=direction1(:,5).*direction1(:,4)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,5,5)=direction1(:,5).*direction1(:,5)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,5,6)=direction1(:,5).*direction1(:,6)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,5,7)=direction1(:,5).*direction1(:,7)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,5,8)=direction1(:,5).*direction1(:,8)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,5,9)=direction1(:,5).*direction1(:,9)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    
    K2e1(:,6,4)=direction1(:,6).*direction1(:,4)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,6,5)=direction1(:,6).*direction1(:,5)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,6,6)=direction1(:,6).*direction1(:,6)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,6,7)=direction1(:,6).*direction1(:,7)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,6,8)=direction1(:,6).*direction1(:,8)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,6,9)=direction1(:,6).*direction1(:,9)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);

    K2e1(:,7,4)=direction1(:,7).*direction1(:,4)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,7,5)=direction1(:,7).*direction1(:,5)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,7,6)=direction1(:,7).*direction1(:,6)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,7,7)=direction1(:,7).*direction1(:,7)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,7,8)=direction1(:,7).*direction1(:,8)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,7,9)=direction1(:,7).*direction1(:,9)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);

    K2e1(:,8,4)=direction1(:,8).*direction1(:,4)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,8,5)=direction1(:,8).*direction1(:,5)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,8,6)=direction1(:,8).*direction1(:,6)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,8,7)=direction1(:,8).*direction1(:,7)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,8,8)=direction1(:,8).*direction1(:,8)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,8,9)=direction1(:,8).*direction1(:,9)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);

    K2e1(:,9,4)=direction1(:,9).*direction1(:,4)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,9,5)=direction1(:,9).*direction1(:,5)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,9,6)=direction1(:,9).*direction1(:,6)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,9,7)=direction1(:,9).*direction1(:,7)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,9,8)=direction1(:,9).*direction1(:,8)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);
    K2e1(:,9,9)=direction1(:,9).*direction1(:,9)./L_mat(:,1)...
        ./l_mat(:,1)./l_mat(:,1)./l_mat(:,1);

    % For the strain of bar 2
    K2e2=zeros(Ncst,9,9);

    K2e2(:,1,1)=direction2(:,1).*direction2(:,1)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,1,2)=direction2(:,1).*direction2(:,2)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,1,3)=direction2(:,1).*direction2(:,3)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,1,7)=direction2(:,1).*direction2(:,7)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,1,8)=direction2(:,1).*direction2(:,8)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,1,9)=direction2(:,1).*direction2(:,9)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);

    K2e2(:,2,1)=direction2(:,2).*direction2(:,1)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,2,2)=direction2(:,2).*direction2(:,2)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,2,3)=direction2(:,2).*direction2(:,3)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,2,7)=direction2(:,2).*direction2(:,7)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,2,8)=direction2(:,2).*direction2(:,8)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,2,9)=direction2(:,2).*direction2(:,9)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);

    K2e2(:,3,1)=direction2(:,3).*direction2(:,1)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,3,2)=direction2(:,3).*direction2(:,2)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,3,3)=direction2(:,3).*direction2(:,3)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,3,7)=direction2(:,3).*direction2(:,7)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,3,8)=direction2(:,3).*direction2(:,8)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,3,9)=direction2(:,3).*direction2(:,9)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);

    K2e2(:,7,1)=direction2(:,7).*direction2(:,1)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,7,2)=direction2(:,7).*direction2(:,2)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,7,3)=direction2(:,7).*direction2(:,3)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,7,7)=direction2(:,7).*direction2(:,7)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,7,8)=direction2(:,7).*direction2(:,8)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,7,9)=direction2(:,7).*direction2(:,9)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);

    K2e2(:,8,1)=direction2(:,8).*direction2(:,1)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,8,2)=direction2(:,8).*direction2(:,2)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,8,3)=direction2(:,8).*direction2(:,3)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,8,7)=direction2(:,8).*direction2(:,7)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,8,8)=direction2(:,8).*direction2(:,8)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,8,9)=direction2(:,8).*direction2(:,9)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);

    K2e2(:,9,1)=direction2(:,9).*direction2(:,1)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,9,2)=direction2(:,9).*direction2(:,2)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,9,3)=direction2(:,9).*direction2(:,3)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,9,7)=direction2(:,9).*direction2(:,7)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,9,8)=direction2(:,9).*direction2(:,8)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);
    K2e2(:,9,9)=direction2(:,9).*direction2(:,9)./L_mat(:,2)...
        ./l_mat(:,2)./l_mat(:,2)./l_mat(:,2);

    % Finally for the strain of the bar 3
    K2e3=zeros(Ncst,9,9);

    K2e3(:,1,1)=direction3(:,1).*direction3(:,1)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,1,2)=direction3(:,1).*direction3(:,2)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,1,3)=direction3(:,1).*direction3(:,3)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,1,4)=direction3(:,1).*direction3(:,4)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,1,5)=direction3(:,1).*direction3(:,5)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,1,6)=direction3(:,1).*direction3(:,6)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    
    K2e3(:,2,1)=direction3(:,2).*direction3(:,1)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,2,2)=direction3(:,2).*direction3(:,2)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,2,3)=direction3(:,2).*direction3(:,3)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,2,4)=direction3(:,2).*direction3(:,4)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,2,5)=direction3(:,2).*direction3(:,5)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,2,6)=direction3(:,2).*direction3(:,6)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);

    K2e3(:,3,1)=direction3(:,3).*direction3(:,1)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,3,2)=direction3(:,3).*direction3(:,2)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,3,3)=direction3(:,3).*direction3(:,3)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,3,4)=direction3(:,3).*direction3(:,4)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,3,5)=direction3(:,3).*direction3(:,5)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,3,6)=direction3(:,3).*direction3(:,6)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);

    K2e3(:,4,1)=direction3(:,4).*direction3(:,1)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,4,2)=direction3(:,4).*direction3(:,2)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,4,3)=direction3(:,4).*direction3(:,3)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,4,4)=direction3(:,4).*direction3(:,4)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,4,5)=direction3(:,4).*direction3(:,5)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,4,6)=direction3(:,4).*direction3(:,6)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);

    K2e3(:,5,1)=direction3(:,5).*direction3(:,1)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,5,2)=direction3(:,5).*direction3(:,2)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,5,3)=direction3(:,5).*direction3(:,3)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,5,4)=direction3(:,5).*direction3(:,4)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,5,5)=direction3(:,5).*direction3(:,5)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,5,6)=direction3(:,5).*direction3(:,6)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);

    K2e3(:,6,1)=direction3(:,6).*direction3(:,1)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,6,2)=direction3(:,6).*direction3(:,2)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,6,3)=direction3(:,6).*direction3(:,3)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,6,4)=direction3(:,6).*direction3(:,4)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,6,5)=direction3(:,6).*direction3(:,5)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);
    K2e3(:,6,6)=direction3(:,6).*direction3(:,6)./L_mat(:,3)...
        ./l_mat(:,3)./l_mat(:,3)./l_mat(:,3);

    % Assemble the second part of the matrix
    d2edx2(:,1,:,:)=squeeze(d2edx2(:,1,:,:))+K2e1;
    d2edx2(:,2,:,:)=squeeze(d2edx2(:,2,:,:))+K2e2;
    d2edx2(:,3,:,:)=squeeze(d2edx2(:,3,:,:))+K2e3;

end